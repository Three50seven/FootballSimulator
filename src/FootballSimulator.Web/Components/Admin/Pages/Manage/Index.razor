@page "/admin/manage"
@using FootballSimulator.Core.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@rendermode InteractiveServer

<PageTitle>Manage Users</PageTitle>

<h3>Manage Users</h3>
@if (manageModel is null)
{
    <p><em>Loading users...</em></p>
}
else
{
    @if (!showForm)
    {
        <div class="d-flex justify-content-end p-3">
            <button class="btn btn-primary" @onclick="ShowAddForm">+ Add New</button>
        </div>
        <ul>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>Name</strong>
                    <span class="text-muted">- UserName (Email)</span>
                </div>
                <div class="btn-group align-content-center">
                    Manage
                </div>
            </li>
            <li class="list-group-item">
                <hr />
            </li>
            @foreach (var user in manageModel.Results)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@user.FirstName @user.LastName</strong>
                        <span class="text-muted">- @user.UserName (@user.Email)</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-secondary me-1" @onclick="() => ShowEditForm(user.Guid)">
                            Edit
                        </button>
                        <button class="btn btn-sm btn-danger"
                                @onclick="() => ShowConfirmModal(user.Guid)">
                            Delete
                        </button>
                    </div>
                </li>
            }
        </ul>
        <ConfirmActionModal @ref="deleteModal"
                    Title="Delete User"
                    Message="Are you sure you want to delete this user?"
                    ActionName="Delete"
                    OnConfirm="DeleteUser" />

    }
    else
    {
        <EditForm Model="@editModel" OnValidSubmit="SaveUser" OnInvalidSubmit="HandleInvalidUser">
            <DataAnnotationsValidator />
            <ValidationSummary />
                    
            <div class="mb-3">
                <label>User Name</label>
                @if (editModel.IsNew)
                {
                    <InputText @bind-Value="editModel.UserName" class="form-control" />
                    <ValidationMessage For="@(() => editModel.UserName)" />
                }
                else
                {
                    <input value="@editModel.UserName" class="form-control input-disabled" readonly />
                }
            </div>

            <div class="mb-3">
                <label>Application User ID</label>
                @if (editModel.IsNew)
                {
                    <InputText @bind-Value="editModel.ApplicationUserId" class="form-control" />
                    <ValidationMessage For="@(() => editModel.ApplicationUserId)" />
                }
                else
                {
                    <input value="@editModel.ApplicationUserId" class="form-control input-disabled" readonly />
                }
            </div>

            <div class="mb-3">
                <label>First Name</label>
                <InputText @bind-Value="editModel.FirstName" class="form-control" />
                <ValidationMessage For="@(() => editModel.FirstName)" />
            </div>

            <div class="mb-3">
                <label>Last Name</label>
                <InputText @bind-Value="editModel.LastName" class="form-control" />
                <ValidationMessage For="@(() => editModel.LastName)" />
            </div>

            <div class="mb-3">
                <label>Email</label>
                <InputText @bind-Value="editModel.Email" class="form-control" />
                <ValidationMessage For="@(() => editModel.Email)" />
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-success">@formModeLabel</button>
                <button class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
            </div>
        </EditForm>
    }
}

@code {
    [Inject] private IUserManageModelService _userManageService { get; set; } = default!;
    [Inject] private IUserEditService _userEditService { get; set; } = default!;
    private bool showForm = false;
    private UserManageModel? manageModel;
    private UserEditModel editModel = new UserEditModel();
    private string formModeLabel => $"{editModel.CreateOrEdit} User"; 
    private ConfirmActionModal? deleteModal;
    private Guid userGuidToDelete;

    protected override async Task OnInitializedAsync()
    {
        manageModel = await _userManageService.BuildModelAsync();
    }

    private async Task ShowConfirmModal(Guid userGuid)
    {
        userGuidToDelete = userGuid;
        if (deleteModal is not null)
        {
            await deleteModal.ShowAsync(userGuid);
        }
    }

    private void ShowAddForm()
    {
        editModel = new UserEditModel();
        showForm = true;
    }


    private async Task ShowEditForm(Guid userGuid)
    {        
        UserEditModel? userEditModel = await _userEditService.BuildModelAsync(userGuid);

        if (userEditModel is null)
        {
            return;
        }
        editModel = userEditModel;
        showForm = true;
    }

    private async Task DeleteUser()
    {
        await _userEditService.DeleteAsync(userGuidToDelete);
        manageModel = await _userManageService.BuildModelAsync();
    }

    private void CancelForm()
    {
        showForm = false;
    }

    private async Task SaveUser()
    {
        await _userEditService.SaveAsync(editModel);
        manageModel = await _userManageService.BuildModelAsync();
        showForm = false;
    }

    private void HandleInvalidUser()
    {
        Console.WriteLine("Validation failed. User not saved.");
    }

}
